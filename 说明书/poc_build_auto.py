#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
åŠŸèƒ½ï¼š
1. ç”Ÿæˆ Pocsuite3 é€šç”¨ POC æ¨¡æ¿
2. æå– Suricata JSON æ—¥å¿—ï¼ˆeve.jsonï¼‰ç¬¬ä¸€æ¡æµé‡ä¿¡æ¯
3. å°†æå–çš„ä¿¡æ¯å¡«å……åˆ°æ¨¡æ¿ä¸­ï¼Œç”Ÿæˆå¯ç”¨ POC
"""
import json
import os
from datetime import datetime

# ===================== é…ç½®é¡¹ï¼ˆæ ¹æ®å®é™…ç¯å¢ƒä¿®æ”¹ï¼‰=====================
# Suricata JSON æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤è·¯å¾„ï¼‰
SURICATA_LOG_PATH = "/var/log/suricata/eve.json"
# ç”Ÿæˆçš„ POC æ–‡ä»¶ä¿å­˜è·¯å¾„
GENERATED_POC_PATH = "suricata_generated_poc.py"
# å½“å‰æ—¥æœŸï¼ˆç”¨äºå¡«å……æ¨¡æ¿ï¼‰
CURRENT_DATE = datetime.now().strftime("%Y-%m-%d")

# ===================== æ­¥éª¤1ï¼šå®šä¹‰ Pocsuite3 é€šç”¨æ¨¡æ¿ =====================
POC_TEMPLATE = '''
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
POC æè¿°ï¼šä» Suricata æ—¥å¿—è‡ªåŠ¨ç”Ÿæˆçš„æ¼æ´æ£€æµ‹è„šæœ¬
ç”Ÿæˆæ—¶é—´ï¼š{generate_time}
Suricata å‘Šè­¦ä¿¡æ¯ï¼š{alert_message}
"""
from pocsuite3.api import (
    Output, POCBase, POC_CATEGORY, register_poc, requests,
    VUL_TYPE, OptString, logger
)

class SuricataAutoPOC(POCBase):
    # ========== æ¼æ´åŸºç¡€ä¿¡æ¯ï¼ˆä» Suricata æ—¥å¿—æå–ï¼‰==========
    vulID = '{vul_id}'          # Suricata è§„åˆ™ SID
    version = '1.0'             # POC ç‰ˆæœ¬
    author = 'AutoGenerated'    # ä½œè€…
    vulDate = '{vul_date}'      # æ¼æ´æ—¥æœŸ
    createDate = '{create_date}'# POC åˆ›å»ºæ—¥æœŸ
    updateDate = '{update_date}'# POC æ›´æ–°æ—¥æœŸ
    references = []             # å‚è€ƒé“¾æ¥
    name = '{poc_name}'         # POC åç§°
    appPowerLink = ''           # åº”ç”¨å‚å•†é“¾æ¥
    appName = '{app_name}'      # åº”ç”¨åç§°
    appVersion = '*'            # å½±å“ç‰ˆæœ¬
    vulType = {vul_type}        # æ¼æ´ç±»å‹
    category = {poc_category}   # POC åˆ†ç±»
    desc = '''{poc_desc}'''     # æ¼æ´æè¿°
    samples = {samples}         # æµ‹è¯•ç›®æ ‡ï¼ˆä» Suricata æ—¥å¿—æå–ï¼‰
    install_requires = ['requests']

    # ========== è‡ªå®šä¹‰å‚æ•° ==========
    def _options(self):
        o = [
            OptString('url', description='ç›®æ ‡URLï¼ˆæ ¼å¼ï¼šhttp://IP:ç«¯å£ï¼‰', required=True),
            OptString('payload', description='æ£€æµ‹Payload', default='{payload}')
        ]
        return o

    # ========== æ¼æ´éªŒè¯é€»è¾‘ ==========
    def _verify(self):
        result = {}
        url = self.get_option('url')
        payload = self.get_option('payload')
        target = f"{url.rstrip('/')}{payload}"

        try:
            # æ„å»ºè¯·æ±‚å¤´ï¼ˆä» Suricata æ—¥å¿—æå– User-Agentï¼‰
            headers = {{
                "User-Agent": "{user_agent}",
                "Accept": "*/*"
            }}

            # æ ¹æ® Suricata æ—¥å¿—é€‰æ‹©è¯·æ±‚æ–¹æ³•ï¼ˆGET/POSTï¼‰
            if "{http_method}" == "GET":
                response = requests.get(
                    target, headers=headers, timeout=5, verify=False, allow_redirects=False
                )
            else:
                response = requests.post(
                    target, headers=headers, timeout=5, verify=False, allow_redirects=False
                )

            # æ¼æ´éªŒè¯è§„åˆ™ï¼ˆåŸºç¡€åŒ¹é…ï¼Œå¯æ ¹æ®å®é™…éœ€æ±‚æ‰©å±•ï¼‰
            if response.status_code == {status_code}:
                result['VerifyInfo'] = {{
                    'URL': target,
                    'Payload': payload,
                    'HTTP_Method': "{http_method}",
                    'Response_Status': response.status_code,
                    'Response_Content': response.text[:200]
                }}
        except Exception as e:
            logger.error(f"éªŒè¯ç›®æ ‡ {{url}} å¤±è´¥ï¼š{{str(e)}}")

        return self.parse_output(result)

    # ========== ç»“æœè§£æ ==========
    def parse_output(self, result):
        output = Output(self)
        if result:
            output.success(result)
        else:
            output.fail("ç›®æ ‡æœªæ£€æµ‹åˆ°è¯¥æ¼æ´")
        return output

# æ³¨å†Œ POC
register_poc(SuricataAutoPOC)
'''

# ===================== æ­¥éª¤2ï¼šæå– Suricata JSON æ—¥å¿—ç¬¬ä¸€æ¡ä¿¡æ¯ =====================
def extract_suricata_log(log_file):
    """
    æå– Suricata eve.json æ—¥å¿—ä¸­ç¬¬ä¸€æ¡å‘Šè­¦æµé‡ä¿¡æ¯
    :param log_file: Suricata JSON æ—¥å¿—è·¯å¾„
    :return: æå–çš„ç‰¹å¾å­—å…¸ï¼Œæ— æœ‰æ•ˆæ•°æ®è¿”å›ç©ºå­—å…¸
    """
    extracted_info = {
        "sid": "100000",  # é»˜è®¤æ¼æ´ID
        "alert_message": "Unknown Vulnerability",
        "dest_ip": "",
        "dest_port": 80,
        "http_uri": "",
        "http_method": "GET",
        "http_user_agent": "Mozilla/5.0 (X11; Ubuntu; Linux x86_64) AppleWebKit/537.36",
        "category": "web-application-attack",
        "status_code": 200
    }

    # è¯»å–æ—¥å¿—æ–‡ä»¶å¹¶æå–ç¬¬ä¸€æ¡å‘Šè­¦æ•°æ®
    if not os.path.exists(log_file):
        print(f"é”™è¯¯ï¼šSuricata æ—¥å¿—æ–‡ä»¶ {log_file} ä¸å­˜åœ¨ï¼")
        return {}

    with open(log_file, 'r', encoding='utf-8') as f:
        for line in f:
            line = line.strip()
            if not line:
                continue
            try:
                # è§£æå•æ¡ JSON æ—¥å¿—
                log_data = json.loads(line)
                # åªå¤„ç†å‘Šè­¦äº‹ä»¶ï¼ˆevent_type=alertï¼‰
                if log_data.get("event_type") == "alert":
                    # æå–æ ¸å¿ƒå­—æ®µ
                    extracted_info["sid"] = str(log_data["alert"].get("sid", extracted_info["sid"]))
                    extracted_info["alert_message"] = log_data["alert"].get("message", extracted_info["alert_message"])
                    extracted_info["dest_ip"] = log_data.get("dest_ip", "")
                    extracted_info["dest_port"] = log_data.get("dest_port", 80)
                    extracted_info["category"] = log_data["alert"].get("category", extracted_info["category"])

                    # æå– HTTP ç›¸å…³å­—æ®µï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if log_data.get("http"):
                        extracted_info["http_uri"] = log_data["http"].get("uri", "")
                        extracted_info["http_method"] = log_data["http"].get("method", "GET")
                        extracted_info["http_user_agent"] = log_data["http"].get("http_user_agent", extracted_info["http_user_agent"])
                        extracted_info["status_code"] = log_data["http"].get("status", 200)

                    print(f"æˆåŠŸæå–ç¬¬ä¸€æ¡ Suricata å‘Šè­¦ä¿¡æ¯ï¼š{extracted_info['alert_message']}")
                    return extracted_info
            except json.JSONDecodeError:
                print(f"è­¦å‘Šï¼šæ— æ•ˆçš„ JSON è¡Œ - {line[:50]}...")
                continue
            except KeyError as e:
                print(f"è­¦å‘Šï¼šæ—¥å¿—å­—æ®µç¼ºå¤± - {e}")
                continue

    print("è­¦å‘Šï¼šæœªåœ¨ Suricata æ—¥å¿—ä¸­æ‰¾åˆ°å‘Šè­¦äº‹ä»¶ï¼")
    return extracted_info

# ===================== æ­¥éª¤3ï¼šå¡«å……æ¨¡æ¿å¹¶ç”Ÿæˆ POC æ–‡ä»¶ =====================
def generate_poc(extracted_info):
    """
    å°†æå–çš„æ—¥å¿—ä¿¡æ¯å¡«å……åˆ°æ¨¡æ¿ï¼Œç”Ÿæˆå¯ç”¨çš„ POC æ–‡ä»¶
    :param extracted_info: æå–çš„æ—¥å¿—ç‰¹å¾å­—å…¸
    """
    if not extracted_info:
        print("é”™è¯¯ï¼šæ— æœ‰æ•ˆæ—¥å¿—ä¿¡æ¯ï¼Œæ— æ³•ç”Ÿæˆ POCï¼")
        return

    # æ˜ å°„æ¼æ´ç±»å‹å’Œ POC åˆ†ç±»ï¼ˆæ ¹æ® Suricata æ—¥å¿—ç±»åˆ«ï¼‰
    vul_type_map = {
        "web-application-attack": "VUL_TYPE.WEB_APP_ATTACK",
        "sql-injection": "VUL_TYPE.INJECTION",
        "buffer-overflow": "VUL_TYPE.BUFFER_OVERFLOW",
        "protocol-error": "VUL_TYPE.PROTOCOL_ERROR"
    }
    poc_category_map = {
        "web-application-attack": "POC_CATEGORY.EXPLOITS.WEBAPP",
        "sql-injection": "POC_CATEGORY.EXPLOITS.WEBAPP",
        "buffer-overflow": "POC_CATEGORY.EXPLOITS.NETWORK",
        "protocol-error": "POC_CATEGORY.EXPLOITS.NETWORK"
    }

    # æ¨¡æ¿å‚æ•°æ›¿æ¢
    poc_params = {
        "generate_time": CURRENT_DATE,
        "vul_id": extracted_info["sid"],
        "alert_message": extracted_info["alert_message"],
        "vul_date": CURRENT_DATE,
        "create_date": CURRENT_DATE,
        "update_date": CURRENT_DATE,
        "poc_name": f"Suricata_Alert_{extracted_info['alert_message']}",
        "app_name": "Web_Service",
        "vul_type": vul_type_map.get(extracted_info["category"], "VUL_TYPE.WEB_APP_ATTACK"),
        "poc_category": poc_category_map.get(extracted_info["category"], "POC_CATEGORY.EXPLOITS.WEBAPP"),
        "poc_desc": f"Suricata æ£€æµ‹åˆ°çš„æ¼æ´ï¼š{extracted_info['alert_message']}\\nç›®æ ‡IPï¼š{extracted_info['dest_ip']}\\næ¶æ„è·¯å¾„ï¼š{extracted_info['http_uri']}",
        "samples": f"['http://{extracted_info['dest_ip']}:{extracted_info['dest_port']}']" if extracted_info["dest_ip"] else "[]",
        "payload": extracted_info["http_uri"],
        "user_agent": extracted_info["http_user_agent"],
        "http_method": extracted_info["http_method"],
        "status_code": extracted_info["status_code"]
    }

    # å¡«å……æ¨¡æ¿å¹¶å†™å…¥æ–‡ä»¶
    try:
        with open(GENERATED_POC_PATH, 'w', encoding='utf-8') as f:
            f.write(POC_TEMPLATE.format(**poc_params))
        print(f"âœ… POC æ–‡ä»¶å·²ç”Ÿæˆï¼š{os.path.abspath(GENERATED_POC_PATH)}")
    except Exception as e:
        print(f"âŒ ç”Ÿæˆ POC æ–‡ä»¶å¤±è´¥ï¼š{e}")

# ===================== ä¸»å‡½æ•° =====================
if __name__ == "__main__":
    # 1. æå– Suricata æ—¥å¿—ä¿¡æ¯
    log_info = extract_suricata_log(SURICATA_LOG_PATH)
    
    # 2. ç”Ÿæˆ POC æ–‡ä»¶
    if log_info:
        generate_poc(log_info)
    
    # 3. è¾“å‡ºä½¿ç”¨æç¤º
    if os.path.exists(GENERATED_POC_PATH):
        print("\\nğŸ“Œ ä½¿ç”¨è¯´æ˜ï¼š")
        print(f"1. è¿è¡Œ POC æ£€æµ‹ç›®æ ‡ï¼špocsuite3 -r {GENERATED_POC_PATH} -u http://{log_info['dest_ip']}:{log_info['dest_port']} -v 2")
        print("2. å¦‚éœ€è‡ªå®šä¹‰ payloadï¼špocsuite3 -r {GENERATED_POC_PATH} -u http://ç›®æ ‡IP:ç«¯å£ --payload '/è‡ªå®šä¹‰è·¯å¾„'")